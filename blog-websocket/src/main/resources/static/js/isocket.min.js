var stompClient=null;var sid="";var telNo="";var name="";function telNoOnBlur(){var a=$("#telNo").val();if(a.length!=11||!isPoneAvailable(a)){return}telNo=a;$.ajax({url:"/api/chat/getInfoByTelNo/"+a,type:"GET",data:{},success:function(c){console.log("消息发送结果:"+c);if(c.flag){sid=c.data.sid;if(c.data.isLogin){name=c.data.name;var b=confirm("当前手机号已经登陆，是否直接登陆?");if(b){login(true)}}else{console.log("当前手机号未登陆。。。")}}else{console.log("获取手机号信息失败。。。")}},error:function(b){console.log("获取手机号信息异常。。。")}})}function resetConnect(){if(stompClient!=null){stompClient.disconnect()}consoleConnected(false);connect();sid=getCookie("sid");if(sid==null||sid==""){return}$.ajax({url:"/api/chat/getInfoBySid/"+sid,type:"GET",data:{},success:function(b){console.log("消息发送结果:"+b);if(b.flag&&b.data!=null&&b.data.telNo!=null&&b.data.telNo!=""){var a=confirm("当前浏览器存在连接，是否直接进行连接?");if(a){name=b.data.name;telNo=b.data.telNo;$("#name").val(telNo);$("#telNo").val(telNo);login(true)}}else{console.log("获取sid对应的人信息无果。。。")}},error:function(a){console.log("获取sid对应的人信息异常。。。")}})}function consoleConnected(a){if(a){console.log("连接成功。。。")}else{console.log("连接关闭。。。")}}function connect(){var a=new SockJS("/socket");stompClient=Stomp.over(a);stompClient.connect({},function(b){consoleConnected(true);console.log("订阅[/topic/online]");stompClient.subscribe("/topic/online",function(c){onlineUpdate(JSON.parse(c.body))});console.log("订阅[/topic/notice]");stompClient.subscribe("/topic/notice",function(c){showResponse(JSON.parse(c.body))})})}function loginChat(){$("#createFileMModal").modal("show")}function setView(a){if(a){document.getElementById("loginBut").style.visibility="hidden";document.getElementById("ChatTab").style.display="block";document.getElementById("publicChatTable").style.display="block";document.getElementById("sendMessageDiv").style.display="block";document.getElementById("wecomeInfo").innerText="欢迎您："+name}else{document.getElementById("loginBut").style.visibility="disable";document.getElementById("ChatTab").style.display="none";document.getElementById("publicChatTable").style.display="none";document.getElementById("sendMessageDiv").style.display="none";document.getElementById("wecomeInfo").innerText=""}}function login(c){var b=$("#telNo").val();if(!isPoneAvailable(b)){alert("请输入正确的手机号");return}name=$("#name").val();console.log("name : "+name);console.log("sid : "+sid);console.log("telNo : "+telNo);try{stompClient.send("/app/change-notice",{},JSON.stringify({"sid":sid,"telNo":telNo,"name":name}))}catch(a){console.log("订阅异常change-notice："+a)}setCookie("sid",sid);setCookie("telNo",telNo);setCookie("name",name);setView(true);$("#createFileMModal").modal("hide")}function showResponse(a){if(a.sendSid==sid){$("#publicChatTable tbody").append('<tr><td class="col-md-1"></td><td class="col-md-8">'+a.message+'</td><td class="col-md-1">'+name+"</td></tr>")}else{$("#publicChatTable tbody").append('<tr><td class="col-md-1">'+a.sendUserName+'</td><td class="col-md-8">'+a.message+'</td><td class="col-md-1"></td></tr>')}}function onlineUpdate(b){$("#publicChat").text("公聊(当前人数:"+b.chatCount+")");$("#privatelyChat").text("私聊");$("#privatelyChatList li").remove();b.chatInfoList.forEach(function a(d,c){console.log("私聊信息："+d);$("#privatelyChatList").append('<li><a href="#">'+d.name+"("+d.telNo+")"+ +"</a><span class='caret'></span></li>")})}function sendMessage(){if(sid==null||sid==""){alert("请先进入。");return}var a=$("#messageInput").val();if(a==""){alert("发送消息不能为空哦")}$.ajax({url:"/api/chat/sendMessage",type:"post",data:{"sid":sid,"name":name,"message":a},success:function(b){console.log("消息发送结果:"+b);if(b.flag){$("#messageInput").val("");console.log("消息发送成功。")}else{alert("消息发送失败")}},error:function(b){alert("消息发送异常")}})}function isPoneAvailable(a){var b=/^[1][3,4,5,7,8][0-9]{9}$/;if(!b.test(a)){return false}else{return true}}function getCookie(b){var a,c=new RegExp("(^| )"+b+"=([^;]*)(;|$)");if(a=document.cookie.match(c)){return unescape(a[2])}else{return null}}function setCookie(a,c){var b=30;var d=new Date();d.setTime(d.getTime()+b*24*60*60*1000);document.cookie=a+"="+escape(c)+";expires="+d.toGMTString()};